(function(e,t,n,r){"use strict";let s=new t.FramePool(function(){return new Float32Array(16)},256);const i=["manifest","onDone","onProgress","onError"];const a=["type","src","stream","credentials","parser"];const o=["onData","onDone"];const f=-1;const u=0;const c=1;function l(e){throw new Error("resl: "+e)}function p(e,t,n){Object.keys(e).forEach(function(e){if(t.indexOf(e)<0){l('invalid parameter "'+e+'" in '+n)}})}function m(e,t){this.state=u;this.ready=false;this.progress=0;this.name=e;this.cancel=t}function d(e){if(typeof e!=="object"||!e){l("invalid or missing configuration")}p(e,i,"config");let t=e.manifest;if(typeof t!=="object"||!t){l("missing manifest")}function n(t){if(t in e){let n=e[t];if(typeof n!=="function"){l('invalid callback "'+t+'"')}return n}return null}let r=n("onDone");if(!r){l("missing onDone() callback")}let s=n("onProgress");let d=n("onError");let y={};let _=u;function E(e){let t=e.name;let n=e.stream;let r=e.type==="binary";let s=e.parser;let i=new XMLHttpRequest;let a=null;let o=new m(t,p);if(n){i.onreadystatechange=l}else{i.onreadystatechange=function(){if(i.readyState===4){l()}}}if(r){i.responseType="arraybuffer"}function l(){if(i.readyState<2||o.state===c||o.state===f){return}if(i.status!==200){return h('error loading resource "'+e.name+'"')}if(i.readyState>2&&o.state===u){let t;if(e.type==="binary"){t=i.response}else{t=i.responseText}if(s.data){try{a=s.data(t)}catch(e){return h(e)}}else{a=t}}if(i.readyState>3&&o.state===u){if(s.done){try{a=s.done()}catch(e){return h(e)}}o.state=c}y[t]=a;o.progress=.75*o.progress+.25;o.ready=e.stream&&!!a||o.state===c;A()}function p(){if(o.state===c||o.state===f){return}i.onreadystatechange=null;i.abort();o.state=f}if(e.credentials){i.withCredentials=true}i.open("GET",e.src,true);i.send();return o}function g(e,t){let n=e.name;let r=e.parser;let s=new m(n,_);let i=t;function a(){if(s.state===u){if(r.data){try{i=r.data(t)}catch(e){return h(e)}}else{i=t}}}function o(e){a();y[n]=i;if(e.lengthComputable){s.progress=Math.max(s.progress,e.loaded/e.total)}else{s.progress=.75*s.progress+.25}A(n)}function l(){a();if(s.state===u){if(r.done){try{i=r.done()}catch(e){return h(e)}}s.state=c}s.progress=1;s.ready=true;y[n]=i;d();A("finish "+n)}function p(){h('error loading asset "'+n+'"')}if(e.stream){t.addEventListener("progress",o)}if(e.type==="image"){t.addEventListener("load",l)}else{let e=false;let n=false;t.addEventListener("loadedmetadata",function(){n=true;if(e){l()}});t.addEventListener("canplay",function(){e=true;if(n){l()}})}t.addEventListener("error",p);function d(){if(e.stream){t.removeEventListener("progress",o)}if(e.type==="image"){t.addEventListener("load",l)}else{t.addEventListener("canplay",l)}t.removeEventListener("error",p)}function _(){if(s.state===c||s.state===f){return}s.state=f;d();t.src=""}if(e.credentials){t.crossOrigin="use-credentials"}else{t.crossOrigin="anonymous"}t.src=e.src;return s}let b={text:E,binary:function(e){return E(e)},image:function(e){return g(e,document.createElement("img"))},video:function(e){return g(e,document.createElement("video"))},audio:function(e){return g(e,document.createElement("audio"))}};let T=Object.keys(t).map(function(e){let n=t[e];if(typeof n==="string"){n={src:n}}else if(typeof n!=="object"||!n){l('invalid asset definition "'+e+'"')}p(n,a,'asset "'+e+'"');function r(t,r,s){let i=s;if(t in n){i=n[t]}if(r.indexOf(i)<0){l("invalid "+t+' "'+i+'" for asset "'+e+'", possible values: '+r)}return i}function s(t,r,s){let i=s;if(t in n){i=n[t]}else if(r){l("missing "+t+' for asset "'+e+'"')}if(typeof i!=="string"){l("invalid "+t+' for asset "'+e+'", must be a string')}return i}function i(e,t){if(e in n.parser){let t=n.parser[e];if(typeof t!=="function"){l("invalid parser callback "+e+' for asset "'+e+'"')}return t}else{return t}}let f={};if("parser"in n){if(typeof n.parser==="function"){f={data:n.parser}}else if(typeof n.parser==="object"&&n.parser){p(n.parser,o,'parser for asset "'+e+'"');if(!("onData"in n.parser)){l('missing onData callback for parser in asset "'+e+'"')}f={data:i("onData"),done:i("onDone")}}else{l('invalid parser for asset "'+e+'"')}}return{name:e,type:r("type",Object.keys(b),"text"),stream:!!n.stream,credentials:!!n.credentials,src:s("src",true,""),parser:f}}).map(function(e){return b[e.type](e)});function h(e){if(_===f||_===c){return}_=f;T.forEach(function(e){e.cancel()});if(d){if(typeof e==="string"){d(new Error("resl: "+e))}else{d(e)}}else{console.error("resl error:",e)}}function A(e){if(_===f||_===c){return}let t=0;let n=0;T.forEach(function(e){if(e.ready){n+=1}t+=e.progress});if(n===T.length){_=c;r(y)}else{if(s){s(t/T.length,e)}}}if(T.length===0){setTimeout(function(){A("done")},1)}}var y={diffuse:{attributes:["a_position","a_normal","a_uv0"],vertexShader:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_position;
      attribute vec3 a_normal;
      attribute vec2 a_uv0;

      varying vec2 v_uv0;

      void main() {
        v_uv0 = a_uv0;
        gl_Position = projection * view * model * vec4(a_position, 1);
      }
    `,fragmentShader:`
      #extension GL_OES_standard_derivatives : enable

      precision mediump float;
      uniform sampler2D u_mainTexture;
      uniform vec2 u_mainTextureTiling;
      uniform vec2 u_mainTextureOffset;

      varying vec2 v_uv0;

      void main () {
        // gl_FragColor = vec4( 1, 1, 1, 1 );
        // gl_FragColor = vec4( v_uv0.x, v_uv0.y, 0, 1 );

        vec2 uv0 = v_uv0 * u_mainTextureTiling + u_mainTextureOffset;

        gl_FragColor = texture2D( u_mainTexture, uv0 );

        if (!gl_FrontFacing) {
          gl_FragColor *= 0.05;
        }
      }
    `},diffuse_skinning:{attributes:["a_position","a_normal","a_uv0","a_joint","a_weight"],vertexShader:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_position;
      attribute vec3 a_normal;
      attribute vec2 a_uv0;
      attribute vec4 a_weight;
      attribute vec4 a_joint;

      uniform sampler2D u_bonesTexture;
      uniform float u_bonesTextureSize;

      varying vec2 v_uv0;

      mat4 getBoneMatrix(const in float i) {
        float size = u_bonesTextureSize;
        float j = i * 4.0;
        float x = mod(j, size);
        float y = floor(j / size);

        float dx = 1.0 / size;
        float dy = 1.0 / size;

        y = dy * (y + 0.5);

        vec4 v1 = texture2D(u_bonesTexture, vec2(dx * (x + 0.5), y));
        vec4 v2 = texture2D(u_bonesTexture, vec2(dx * (x + 1.5), y));
        vec4 v3 = texture2D(u_bonesTexture, vec2(dx * (x + 2.5), y));
        vec4 v4 = texture2D(u_bonesTexture, vec2(dx * (x + 3.5), y));

        mat4 bone = mat4(v1, v2, v3, v4);

        return bone;
      }

      void main() {
        v_uv0 = a_uv0;
        mat4 matSkin =
          getBoneMatrix(a_joint.x) * a_weight.x +
          getBoneMatrix(a_joint.y) * a_weight.y +
          getBoneMatrix(a_joint.z) * a_weight.z +
          getBoneMatrix(a_joint.w) * a_weight.w ;

        gl_Position = projection * view * model * matSkin * vec4(a_position, 1);
      }
    `,fragmentShader:`
      #extension GL_OES_standard_derivatives : enable

      precision mediump float;
      uniform sampler2D u_mainTexture;

      varying vec2 v_uv0;

      void main () {
        // gl_FragColor = vec4( 1, 1, 1, 1 );
        // gl_FragColor = vec4( v_uv0.x, v_uv0.y, 0, 1 );

        gl_FragColor = texture2D( u_mainTexture, v_uv0 );

        if (!gl_FrontFacing) {
          gl_FragColor *= 0.05;
        }
      }
    `}};const _=WebGLRenderingContext.prototype;var E={diffuse:{name:"diffuse",program:"diffuse",parameters:{position:{type:_.FLOAT_VEC3,semantic:"POSITION"},normal:{type:_.FLOAT_VEC3,semantic:"NORMAL"},uv0:{type:_.FLOAT_VEC2,semantic:"TEXCOORD_0"},model:{type:_.FLOAT_MAT4,semantic:"MODEL"},view:{type:_.FLOAT_MAT4,semantic:"VIEW"},projection:{type:_.FLOAT_MAT4,semantic:"PROJECTION"},mainTexture:{type:_.SAMPLER_2D},mainTextureTiling:{type:_.FLOAT_VEC2},mainTextureOffset:{type:_.FLOAT_VEC2}},attributes:{a_position:"position",a_normal:"normal",a_uv0:"uv0"},uniforms:{model:"model",u_mainTexture:"mainTexture",u_mainTextureTiling:"mainTextureTiling",u_mainTextureOffset:"mainTextureOffset"}},diffuse_skinning:{name:"diffuse_skinning",program:"diffuse_skinning",parameters:{position:{type:_.FLOAT_VEC3,semantic:"POSITION"},normal:{type:_.FLOAT_VEC3,semantic:"NORMAL"},uv0:{type:_.FLOAT_VEC2,semantic:"TEXCOORD_0"},joint:{type:_.FLOAT_VEC4,semantic:"JOINT"},weight:{type:_.FLOAT_VEC4,semantic:"WEIGHT"},model:{type:_.FLOAT_MAT4,semantic:"MODEL"},view:{type:_.FLOAT_MAT4,semantic:"VIEW"},projection:{type:_.FLOAT_MAT4,semantic:"PROJECTION"},mainTexture:{type:_.SAMPLER_2D},bonesTexture:{type:_.SAMPLER_2D},bonesTextureSize:{type:_.FLOAT}},attributes:{a_position:"position",a_normal:"normal",a_uv0:"uv0",a_joint:"joint",a_weight:"weight"},uniforms:{model:"model",u_bonesTexture:"bonesTexture",u_bonesTextureSize:"bonesTextureSize",u_mainTexture:"mainTexture"}}};const g=WebGLRenderingContext.prototype;let b={};for(let e in y){b[e]=y[e]}let T={};for(let e in E){T[e]=E[e]}function h(e){if(e===g.REPEAT){return"repeat"}else if(e===g.CLAMP_TO_EDGE){return"clamp"}else if(e===g.MIRRORED_REPEAT){return"mirror"}return"repeat"}function A(e){if(e===g.NEAREST){return"nearest"}else if(e===g.LINEAR){return"linear"}else if(e===g.LINEAR_MIPMAP_LINEAR){return"linear mipmap linear"}else if(e===g.NEAREST_MIPMAP_LINEAR){return"nearest mipmap linear"}else if(e===g.LINEAR_MIPMAP_NEAREST){return"linear mipmap nearest"}else if(e===g.NEAREST_MIPMAP_NEAREST){return"nearest mipmap nearest"}return"nearest mipmap linear"}function L(e,t){e.nodes.forEach(e=>{t(e);n.utils.walk(e,e=>{return t(e)})})}function O(e,t,r){if(t._parent){return n.utils.replace(t,r)}for(let n=0;n<e.nodes.length;++n){if(e.nodes[n]===t){e.nodes[n]=r;return}}}function v(e,t,n){for(let t in T){let r=T[t];let s=b[r.program];let i={cull:{enable:true,face:"back"},vert:s.vertexShader,frag:s.fragmentShader,primitive:e.prop("primitive"),offset:e.prop("offset"),count:e.prop("count"),elements:e.prop("elements"),attributes:{},uniforms:{}};for(let t in r.attributes){i.attributes[t]=e.prop(`attributes.${t}`)}for(let t in r.uniforms){i.uniforms[t]=e.prop(`uniforms.${t}`)}n[t]=e(i)}}function R(e,t,s,i){s.forEach(s=>{let a=e.nodes[s];let o=new n.Node(a.name);let f;o._id=s;o._parent=t;f=a.translation;o.lpos=f?r.vec3.new(f[0],f[1],f[2]):r.vec3.new(0,0,0);f=a.rotation;o.lrot=f?r.quat.new(f[0],f[1],f[2],f[3]):r.quat.new(0,0,0,1);f=a.scale;o.lscale=f?r.vec3.new(f[0],f[1],f[2]):r.vec3.new(1,1,1);o._meshes=a.meshes;o._skeletons=a.skeletons;o._skin=a.skin;o._extras=a.extras;if(a.children){R(e,o,a.children,o.children)}i.push(o)});return i}function x(e,t,s,i){let a=i[s];if(a){if(t){a._parent=t;t.children.push(a)}return}let o=e.nodes[s];a=new n.Node(o.name);a._id=s;a._parent=t;let f;f=o.translation;a.lpos=f?r.vec3.new(f[0],f[1],f[2]):r.vec3.new(0,0,0);f=o.rotation;a.lrot=f?r.quat.new(f[0],f[1],f[2],f[3]):r.quat.new(0,0,0,1);f=o.scale;a.lscale=f?r.vec3.new(f[0],f[1],f[2]):r.vec3.new(1,1,1);i[s]=a;if(t){t.children.push(a)}if(o.children){o.children.forEach(t=>{x(e,a,t,i)})}}function w(e,t,n,r){let s={};let i={};for(let r in t.textures){let a=t.textures[r];let o=t.images[a.source];n[r]=e.texture();i[r]=t.samplers[a.sampler];s[r]={type:"image",src:`${t.baseURL}/${o.uri}`}}d({manifest:s,onError(e){console.error(e)},onDone(e){for(let t in e){let r=i[t];n[t]({data:e[t],wrapS:h(r.wrapS||g.REPEAT),wrapT:h(r.wrapT||g.REPEAT),mag:A(r.magFilter||g.LINEAR),min:A(r.minFilter||g.NEAREST_MIPMAP_LINEAR),mipmap:"nice",flipY:true})}if(r){r(null,n)}}})}function S(e,t,n,r){let s={};let i={};for(let e in t.buffers){let n=t.buffers[e];s[e]={type:"binary",src:`${t.baseURL}/${n.uri}`};i[e]=[]}for(let r in t.bufferViews){let s=t.bufferViews[r];if(s.target===e._gl.ARRAY_BUFFER){n[r]=e.buffer(s.byteLength)}else if(s.target===e._gl.ELEMENT_ARRAY_BUFFER){n[r]=e.elements(s.byteLength)}else{n[r]=new ArrayBuffer}i[s.buffer].push(r)}d({manifest:s,onError(e){console.error(e)},onDone(e){for(let r in e){let s=i[r];s.forEach(s=>{let i=t.bufferViews[s];if(i.target){let t=n[s];t({type:"uint16",data:new Uint8Array(e[r],i.byteOffset,i.byteLength)})}else{n[s]=e[r].slice(i.byteOffset,i.byteOffset+i.byteLength)}})}if(r){r(null,n)}}})}function I(e,t,n,r,s){if(!t.extras||!t.extras.prefabs){if(s){s(null,r)}return}let i=0;let a={};for(let e in t.extras.prefabs){let n=t.extras.prefabs[e];a[e]={type:"text",src:`${t.baseURL}/${n.uri}`,parser:JSON.parse};++i}d({manifest:a,onError(e){console.error(e)},onDone(t){for(let o in t){let f=a[o].src;let u=t[o];let c=f.lastIndexOf("/");if(c!==-1){u.baseURL=f.substring(0,c)}else{u.baseURL=f}M(e,u,n,(e,t)=>{r[o]=t;--i;if(i===0&&s){s(null,r)}})}}})}function M(e,t,n,s){let i=t.scenes[t.scene];let a={name:i.name,json:t,nodes:[],joints:{}};for(let e in t.programs){b[e]=t.programs[e]}for(let e in t.techniques){T[e]=t.techniques[e]}n.programs=b;n.techniques=T;for(let e in t.meshes){n.meshes[e]=t.meshes[e]}for(let e in t.materials){n.materials[e]=t.materials[e]}for(let e in t.accessors){n.accessors[e]=t.accessors[e]}v(e,t,n.commands);R(t,null,i.nodes,a.nodes);for(let e in t.nodes){let n=t.nodes[e];if(n.jointName){x(t,null,e,a.joints)}}w(e,t,n.textures);S(e,t,n.buffers);I(e,t,n,n.prefabs,(e,t)=>{L(a,e=>{console.log(e.name);if(e._extras&&e._extras.prefab){let s=e._extras.prefab;let i=t[s];let o=i.nodes[0];let f=o.deepClone((e,t)=>{e._meshes=t._meshes;e._skeletons=t._skeletons;e._skin=t._skin;e._extras=t._extras});r.vec3.copy(f.lpos,e.lpos);r.vec3.copy(f.lscale,e.lscale);r.quat.copy(f.lrot,e.lrot);O(a,e,f);n._dirty=true;return false}return true})});s(null,a)}function N(e,t,n){d({manifest:{json:{type:"text",src:t,parser:JSON.parse}},onDone(r){let s=t.lastIndexOf("/");if(s!==-1){r.json.baseURL=t.substring(0,s)}else{r.json.baseURL=t}let i={_dirty:false,name:"",json:"",nodes:[],joints:{},techniques:{},programs:{},meshes:{},materials:{},accessors:{},textures:{},buffers:{},prefabs:{},commands:{}};M(e,r.json,i,(e,t)=>{i.name=t.name;i.json=t.json;i.nodes=t.nodes;i.joints=t.joints;if(n){n(null,i)}})},onError(e){console.error(e);n(e)}})}const P=WebGLRenderingContext.prototype;let j=r.mat4.create();function C(e){if(e==="SCALAR"){return 1}else if(e==="VEC2"){return 2}else if(e==="VEC3"){return 3}else if(e==="VEC4"){return 4}else if(e==="MAT2"){return 4}else if(e==="MAT3"){return 9}else if(e==="MAT4"){return 16}return 1}function F(e){if(e===P.POINTS){return"points"}else if(e===P.LINES){return"lines"}else if(e===P.LINE_LOOP){return"line loop"}else if(e===P.LINE_STRIP){return"line strip"}else if(e===P.TRIANGLES){return"triangles"}else if(e===P.TRIANGLE_STRIP){return"triangle strip"}else if(e===P.TRIANGLE_FAN){return"triangle fan"}return"triangles"}function D(e,t,n){let i=e.materials[n.material];let a=i.technique;let o=e.techniques[a];let f=e.programs[o.program];let u={techID:a,primitive:F(n.mode),attributes:{},uniforms:{}};f.attributes.forEach(t=>{let r=o.attributes[t];let s=o.parameters[r];let i=n.attributes[s.semantic];if(!i){console.warn(`can not find attribute by semantic ${s.semantic}`);return}let a=e.accessors[i];u.attributes[t]={buffer:e.buffers[a.bufferView],offset:a.byteOffset,stride:a.byteStride,type:a.componentType,size:C(a.type)}});for(let t in o.uniforms){let n=o.uniforms[t];let r=o.parameters[n];let s=i.values[n];if(s!==undefined){if(r.type===P.SAMPLER_2D){u.uniforms[t]=e.textures[s]}else{u.uniforms[t]=s}continue}if(r.value!==undefined){if(r.type===P.SAMPLER_2D){u.uniforms[t]=e.textures[r.value]}else{u.uniforms[t]=s}}}if(n.indices){let t=e.accessors[n.indices];u.elements=e.buffers[t.bufferView];u.offset=t.byteOffset;u.count=t.count}t.getWorldMatrix(j);u.uniforms.model=r.mat4.array(s.alloc(),j);return u}function k(){s.reset()}e.reset=k;e.load=N;e.buildCommandData=D})(this.regltf=this.regltf||{},window.memop,window.sgraph,window.vmath);
//# sourceMappingURL=./dist/regltf.min.js.map