(function(e,t,n){"use strict";const r=["manifest","onDone","onProgress","onError"];const i=["type","src","stream","credentials","parser"];const s=["onData","onDone"];const a=-1;const o=0;const f=1;function u(e){throw new Error("resl: "+e)}function c(e,t,n){Object.keys(e).forEach(function(e){if(t.indexOf(e)<0){u('invalid parameter "'+e+'" in '+n)}})}function l(e,t){this.state=o;this.ready=false;this.progress=0;this.name=e;this.cancel=t}function p(e){if(typeof e!=="object"||!e){u("invalid or missing configuration")}c(e,r,"config");let t=e.manifest;if(typeof t!=="object"||!t){u("missing manifest")}function n(t){if(t in e){let n=e[t];if(typeof n!=="function"){u('invalid callback "'+t+'"')}return n}return null}let p=n("onDone");if(!p){u("missing onDone() callback")}let m=n("onProgress");let d=n("onError");let y={};let g=o;function b(e){let t=e.name;let n=e.stream;let r=e.type==="binary";let i=e.parser;let s=new XMLHttpRequest;let u=null;let c=new l(t,m);if(n){s.onreadystatechange=p}else{s.onreadystatechange=function(){if(s.readyState===4){p()}}}if(r){s.responseType="arraybuffer"}function p(){if(s.readyState<2||c.state===f||c.state===a){return}if(s.status!==200){return T('error loading resource "'+e.name+'"')}if(s.readyState>2&&c.state===o){let t;if(e.type==="binary"){t=s.response}else{t=s.responseText}if(i.data){try{u=i.data(t)}catch(e){return T(e)}}else{u=t}}if(s.readyState>3&&c.state===o){if(i.done){try{u=i.done()}catch(e){return T(e)}}c.state=f}y[t]=u;c.progress=.75*c.progress+.25;c.ready=e.stream&&!!u||c.state===f;v()}function m(){if(c.state===f||c.state===a){return}s.onreadystatechange=null;s.abort();c.state=a}if(e.credentials){s.withCredentials=true}s.open("GET",e.src,true);s.send();return c}function h(e,t){let n=e.name;let r=e.parser;let i=new l(n,g);let s=t;function u(){if(i.state===o){if(r.data){try{s=r.data(t)}catch(e){return T(e)}}else{s=t}}}function c(e){u();y[n]=s;if(e.lengthComputable){i.progress=Math.max(i.progress,e.loaded/e.total)}else{i.progress=.75*i.progress+.25}v(n)}function p(){u();if(i.state===o){if(r.done){try{s=r.done()}catch(e){return T(e)}}i.state=f}i.progress=1;i.ready=true;y[n]=s;d();v("finish "+n)}function m(){T('error loading asset "'+n+'"')}if(e.stream){t.addEventListener("progress",c)}if(e.type==="image"){t.addEventListener("load",p)}else{let e=false;let n=false;t.addEventListener("loadedmetadata",function(){n=true;if(e){p()}});t.addEventListener("canplay",function(){e=true;if(n){p()}})}t.addEventListener("error",m);function d(){if(e.stream){t.removeEventListener("progress",c)}if(e.type==="image"){t.addEventListener("load",p)}else{t.addEventListener("canplay",p)}t.removeEventListener("error",m)}function g(){if(i.state===f||i.state===a){return}i.state=a;d();t.src=""}if(e.credentials){t.crossOrigin="use-credentials"}else{t.crossOrigin="anonymous"}t.src=e.src;return i}let _={text:b,binary:function(e){return b(e)},image:function(e){return h(e,document.createElement("img"))},video:function(e){return h(e,document.createElement("video"))},audio:function(e){return h(e,document.createElement("audio"))}};let E=Object.keys(t).map(function(e){let n=t[e];if(typeof n==="string"){n={src:n}}else if(typeof n!=="object"||!n){u('invalid asset definition "'+e+'"')}c(n,i,'asset "'+e+'"');function r(t,r,i){let s=i;if(t in n){s=n[t]}if(r.indexOf(s)<0){u("invalid "+t+' "'+s+'" for asset "'+e+'", possible values: '+r)}return s}function a(t,r,i){let s=i;if(t in n){s=n[t]}else if(r){u("missing "+t+' for asset "'+e+'"')}if(typeof s!=="string"){u("invalid "+t+' for asset "'+e+'", must be a string')}return s}function o(e,t){if(e in n.parser){let t=n.parser[e];if(typeof t!=="function"){u("invalid parser callback "+e+' for asset "'+e+'"')}return t}else{return t}}let f={};if("parser"in n){if(typeof n.parser==="function"){f={data:n.parser}}else if(typeof n.parser==="object"&&n.parser){c(n.parser,s,'parser for asset "'+e+'"');if(!("onData"in n.parser)){u('missing onData callback for parser in asset "'+e+'"')}f={data:o("onData"),done:o("onDone")}}else{u('invalid parser for asset "'+e+'"')}}return{name:e,type:r("type",Object.keys(_),"text"),stream:!!n.stream,credentials:!!n.credentials,src:a("src",true,""),parser:f}}).map(function(e){return _[e.type](e)});function T(e){if(g===a||g===f){return}g=a;E.forEach(function(e){e.cancel()});if(d){if(typeof e==="string"){d(new Error("resl: "+e))}else{d(e)}}else{console.error("resl error:",e)}}function v(e){if(g===a||g===f){return}let t=0;let n=0;E.forEach(function(e){if(e.ready){n+=1}t+=e.progress});if(n===E.length){g=f;p(y)}else{if(m){m(t/E.length,e)}}}if(E.length===0){setTimeout(function(){v("done")},1)}}var m={diffuse:{attributes:["a_position","a_normal","a_uv0"],vertexShader:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_position;
      attribute vec3 a_normal;
      attribute vec2 a_uv0;

      varying vec2 v_uv0;

      void main() {
        v_uv0 = a_uv0;
        gl_Position = projection * view * model * vec4(a_position, 1);
      }
    `,fragmentShader:`
      #extension GL_OES_standard_derivatives : enable

      precision mediump float;
      uniform sampler2D u_mainTexture;

      varying vec2 v_uv0;

      void main () {
        // gl_FragColor = vec4( 1, 1, 1, 1 );
        // gl_FragColor = vec4( v_uv0.x, v_uv0.y, 0, 1 );

        gl_FragColor = texture2D( u_mainTexture, v_uv0 );

        if (!gl_FrontFacing) {
          gl_FragColor *= 0.05;
        }
      }
    `},diffuse_skinning:{attributes:["a_position","a_normal","a_uv0","a_joint","a_weight"],vertexShader:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_position;
      attribute vec3 a_normal;
      attribute vec2 a_uv0;
      attribute vec4 a_weight;
      attribute vec4 a_joint;

      uniform sampler2D u_bonesTexture;
      uniform float u_bonesTextureSize;

      varying vec2 v_uv0;

      mat4 getBoneMatrix(const in float i) {
        float size = u_bonesTextureSize;
        float j = i * 4.0;
        float x = mod(j, size);
        float y = floor(j / size);

        float dx = 1.0 / size;
        float dy = 1.0 / size;

        y = dy * (y + 0.5);

        vec4 v1 = texture2D(u_bonesTexture, vec2(dx * (x + 0.5), y));
        vec4 v2 = texture2D(u_bonesTexture, vec2(dx * (x + 1.5), y));
        vec4 v3 = texture2D(u_bonesTexture, vec2(dx * (x + 2.5), y));
        vec4 v4 = texture2D(u_bonesTexture, vec2(dx * (x + 3.5), y));

        mat4 bone = mat4(v1, v2, v3, v4);

        return bone;
      }

      void main() {
        v_uv0 = a_uv0;
        mat4 matSkin =
          getBoneMatrix(a_joint.x) * a_weight.x +
          getBoneMatrix(a_joint.y) * a_weight.y +
          getBoneMatrix(a_joint.z) * a_weight.z +
          getBoneMatrix(a_joint.w) * a_weight.w ;

        gl_Position = projection * view * model * matSkin * vec4(a_position, 1);
      }
    `,fragmentShader:`
      #extension GL_OES_standard_derivatives : enable

      precision mediump float;
      uniform sampler2D u_mainTexture;

      varying vec2 v_uv0;

      void main () {
        // gl_FragColor = vec4( 1, 1, 1, 1 );
        // gl_FragColor = vec4( v_uv0.x, v_uv0.y, 0, 1 );

        gl_FragColor = texture2D( u_mainTexture, v_uv0 );

        if (!gl_FrontFacing) {
          gl_FragColor *= 0.05;
        }
      }
    `}};const d=WebGLRenderingContext.prototype;var y={diffuse:{name:"diffuse",program:"diffuse",parameters:{position:{type:d.FLOAT_VEC3,semantic:"POSITION"},normal:{type:d.FLOAT_VEC3,semantic:"NORMAL"},uv0:{type:d.FLOAT_VEC2,semantic:"TEXCOORD_0"},model:{type:d.FLOAT_MAT4,semantic:"MODEL"},view:{type:d.FLOAT_MAT4,semantic:"VIEW"},projection:{type:d.FLOAT_MAT4,semantic:"PROJECTION"},mainTexture:{type:d.SAMPLER_2D}},attributes:{a_position:"position",a_normal:"normal",a_uv0:"uv0"},uniforms:{model:"model",u_mainTexture:"mainTexture"}},diffuse_skinning:{name:"diffuse_skinning",program:"diffuse_skinning",parameters:{position:{type:d.FLOAT_VEC3,semantic:"POSITION"},normal:{type:d.FLOAT_VEC3,semantic:"NORMAL"},uv0:{type:d.FLOAT_VEC2,semantic:"TEXCOORD_0"},joint:{type:d.FLOAT_VEC4,semantic:"JOINT"},weight:{type:d.FLOAT_VEC4,semantic:"WEIGHT"},model:{type:d.FLOAT_MAT4,semantic:"MODEL"},view:{type:d.FLOAT_MAT4,semantic:"VIEW"},projection:{type:d.FLOAT_MAT4,semantic:"PROJECTION"},mainTexture:{type:d.SAMPLER_2D},bonesTexture:{type:d.SAMPLER_2D},bonesTextureSize:{type:d.FLOAT}},attributes:{a_position:"position",a_normal:"normal",a_uv0:"uv0",a_joint:"joint",a_weight:"weight"},uniforms:{model:"model",u_bonesTexture:"bonesTexture",u_bonesTextureSize:"bonesTextureSize",u_mainTexture:"mainTexture"}}};let g={};for(let e in m){g[e]=m[e]}let b={};for(let e in y){b[e]=y[e]}function h(e,t,n){for(let t in b){let r=b[t];let i=g[r.program];let s={cull:{enable:true,face:"back"},vert:i.vertexShader,frag:i.fragmentShader,primitive:e.prop("primitive"),offset:e.prop("offset"),count:e.prop("count"),elements:e.prop("elements"),attributes:{},uniforms:{}};for(let t in r.attributes){s.attributes[t]=e.prop(`attributes.${t}`)}for(let t in r.uniforms){s.uniforms[t]=e.prop(`uniforms.${t}`)}n[t]=e(s)}}function _(e,r,i,s){s.forEach(s=>{let a=e.nodes[s];let o=new t.Node(a.name);let f;o._id=s;o._parent=i;f=a.translation;o.lpos=f?n.vec3.new(f[0],f[1],f[2]):n.vec3.new(0,0,0);f=a.rotation;o.lrot=f?n.quat.new(f[0],f[1],f[2],f[3]):n.quat.new(0,0,0,1);f=a.scale;o.lscale=f?n.vec3.new(f[0],f[1],f[2]):n.vec3.new(1,1,1);o._meshes=a.meshes;o._skeletons=a.skeletons;o._skin=a.skin;o._extras=a.extras;if(a.children){_(e,o.children,o,a.children)}r.push(o)});return r}function E(e,r,i,s){let a=r[s];if(a){if(i){a._parent=i;i.children.push(a)}return}let o=e.nodes[s];a=new t.Node(o.name);a._id=s;a._parent=i;let f;f=o.translation;a.lpos=f?n.vec3.new(f[0],f[1],f[2]):n.vec3.new(0,0,0);f=o.rotation;a.lrot=f?n.quat.new(f[0],f[1],f[2],f[3]):n.quat.new(0,0,0,1);f=o.scale;a.lscale=f?n.vec3.new(f[0],f[1],f[2]):n.vec3.new(1,1,1);r[s]=a;if(i){i.children.push(a)}if(o.children){o.children.forEach(t=>{E(e,r,a,t)})}}function T(e,t,n,r){let i={};for(let r in t.textures){let s=t.textures[r];let a=t.images[s.source];n[r]=e.texture();i[r]={type:"image",src:`${t.baseURL}/${a.uri}`}}p({manifest:i,onError(e){console.error(e)},onDone(e){for(let t in e){n[t]({data:e[t],wrapS:"repeat",wrapT:"repeat",mag:"linear",min:"mipmap",mipmap:"nice",flipY:true})}if(r){r(null,n)}}})}function v(e,t,n,r){let i={};let s={};for(let e in t.buffers){let n=t.buffers[e];i[e]={type:"binary",src:`${t.baseURL}/${n.uri}`};s[e]=[]}for(let r in t.bufferViews){let i=t.bufferViews[r];if(i.target===e._gl.ARRAY_BUFFER){n[r]=e.buffer(i.byteLength)}else if(i.target===e._gl.ELEMENT_ARRAY_BUFFER){n[r]=e.elements(i.byteLength)}else{n[r]=new ArrayBuffer}s[i.buffer].push(r)}p({manifest:i,onError(e){console.error(e)},onDone(e){for(let r in e){let i=s[r];i.forEach(i=>{let s=t.bufferViews[i];if(s.target){let t=n[i];t({type:"uint16",data:new Uint8Array(e[r],s.byteOffset,s.byteLength)})}else{n[i]=e[r].slice(s.byteOffset,s.byteOffset+s.byteLength)}})}if(r){r(null,n)}}})}function L(e,t,n){let r=t.scenes[t.scene];let i={name:r.name,json:t,nodes:[],joints:{},techniques:{},programs:{},textures:{},buffers:{},commands:{}};for(let e in t.programs){g[e]=t.programs[e]}for(let e in t.techniques){b[e]=t.techniques[e]}i.programs=g;i.techniques=b;h(e,t,i.commands);_(t,i.nodes,null,r.nodes);for(let e in t.nodes){let n=t.nodes[e];if(n.jointName){E(t,i.joints,null,e)}}T(e,t,i.textures);v(e,t,i.buffers);n(null,i)}function O(e,t,n){p({manifest:{json:{type:"text",src:t,parser:JSON.parse}},onDone(r){let i=t.lastIndexOf("/");if(i!==-1){r.json.baseURL=t.substring(0,i)}else{r.json.baseURL=t}L(e,r.json,n)},onError(e){console.error(e);n(e)}})}const A=WebGLRenderingContext.prototype;let w=n.mat4.create();function x(e){if(e==="SCALAR"){return 1}else if(e==="VEC2"){return 2}else if(e==="VEC3"){return 3}else if(e==="VEC4"){return 4}else if(e==="MAT2"){return 4}else if(e==="MAT3"){return 9}else if(e==="MAT4"){return 16}return 1}function R(e){if(e===A.POINTS){return"points"}else if(e===A.LINES){return"lines"}else if(e===A.LINE_LOOP){return"line loop"}else if(e===A.LINE_STRIP){return"line strip"}else if(e===A.TRIANGLES){return"triangles"}else if(e===A.TRIANGLE_STRIP){return"triangle strip"}else if(e===A.TRIANGLE_FAN){return"triangle fan"}return"triangles"}function S(e,t,r){let i=e.json;let s=i.materials[r.material];let a=s.technique;let o=e.techniques[a];let f=e.programs[o.program];let u={techID:a,primitive:R(r.mode),attributes:{},uniforms:{}};f.attributes.forEach(t=>{let n=o.attributes[t];let s=o.parameters[n];let a=r.attributes[s.semantic];if(!a){console.warn(`can not find attribute by semantic ${s.semantic}`);return}let f=i.accessors[a];u.attributes[t]={buffer:e.buffers[f.bufferView],offset:f.byteOffset,stride:f.byteStride,type:f.componentType,size:x(f.type)}});for(let t in o.uniforms){let n=o.uniforms[t];let r=o.parameters[n];let i=s.values[n];if(i!==undefined){if(r.type===A.SAMPLER_2D){u.uniforms[t]=e.textures[i]}else{u.uniforms[t]=i}continue}if(r.value!==undefined){if(r.type===A.SAMPLER_2D){u.uniforms[t]=e.textures[r.value]}else{u.uniforms[t]=i}}}if(r.indices){let t=i.accessors[r.indices];u.elements=e.buffers[t.bufferView];u.offset=t.byteOffset;u.count=t.count}t.getWorldMatrix(w);let c=new Float32Array(16);n.mat4.array(c,w);u.uniforms.model=c;return u}e.load=O;e.buildCommandData=S})(this.regltf=this.regltf||{},window.sgraph,window.vmath);
//# sourceMappingURL=./dist/regltf.min.js.map